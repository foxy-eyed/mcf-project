# ДЗ#4

Содержание
 - [Описание проблемы](#описание-проблемы)
 - [Предложения по исправлению ситуации](#предложения-по-исправлению-ситуации)
 - [Расчёт Instability](#расчёт-instability)
 - [План работы](#план-работы)

## Описание проблемы

**Цель задания** — необходимо исправить систему, которую сделали до нас.

В качестве **исходной системы** взяла систему из задания, т.к. мои системы из нулевой и первой ДЗ «не бьются»
с целевой из-за нейминга и критериев разбиения на контексты — слишком сложно проецировать одно в другое).

В качестве **целевой** — система из третьей ДЗ, скорректированная после разбора
(дополнительно для уменьшения когнитивной нагрузки перекрасила блоки и подогнала позиционирование сервисов под источник).

| Source                                                                                            | Target                                                                                            |
|---------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| ![Source](https://github.com/foxy-eyed/mcf-project/blob/hw-4/homework-4/img/source_structure.jpg) | ![Target](https://github.com/foxy-eyed/mcf-project/blob/hw-4/homework-4/img/target_structure.jpg) |

### Проблемы, найденные в исходной системе

1. Матчинг внутри монолита исполнения заказов.
   - Объединили Core-поддомен с растущей сложностью с Generic-поддоменами исполнения услуг и 
контролем качества => расхождение характеристик в одном монолите;
   - Под характеристики матчинга требуется специфический архитектурный стиль;
   - Команда, занимающаяся матчингом, говорит на другом языке (другой контекст);
2. Энтити-сервис воркеров, который является источником информации о воркерах для всех сервисов.
Любое изменение структуры данных потенциально создает риск для работы всех сервисов, которые забирают данные о воркерах.
Высокая связанность между энтити-сервисом воркеров и его консьюмерами увеличивает глобальную сложность системы.
Отказ сервиса сломает всю систему.
3. Общий сервис биллинга для воркеров и клиентов.
   - Различающиеся архитектурные характеристики (разная частота деплоев);
   - Нарушаем CatFinCompliance из-за общей базы;
   - Разные контексты.

## Предложения по исправлению ситуации

![Transformation](https://github.com/foxy-eyed/mcf-project/blob/hw-4/homework-4/img/transformation.jpg)

1. Выносим матчинг в отдельный сервис.
2. Энтити-сервис воркеров объединяем с сервисом Скоринга, который будет асинхронно стримить данные о воркерах в 
сервис Матчинга и сервис Исполнения заказов.
3. Разделяем общий сервис расчётов с воркерами и клиентами на два.

## Расчёт Instability

### Instability энтити-сервиса воркеров до ликвидации

![Entity Service Instability](https://github.com/foxy-eyed/mcf-project/blob/hw-4/homework-4/img/entity_service_instability.jpg)

### Instability матчера после вынесения

![Matcher Instability](https://github.com/foxy-eyed/mcf-project/blob/hw-4/homework-4/img/matcher_instability.jpg)

### Instability сервисов расчётов

Тут ничего не поменяется — у сервисов после разделения будет по одной входящей связи и 0 исходящих, 
так же как было до разделения. Instability = 0.

## План работы

### Кейс: есть ресурсы, не хватает экспертизы

1. Самым безопасным первым шагом будет распил сервиса расчётов на два. Границы сервисов будут определяться 
bounded-контекстами — «списание средств с исполнителей», «выплата вознаграждений воркерам».

   Вводные:
   - новая база не нужна (если текущая удовлетворяла CatFinCompliance),
   - новая архитектура не нужна,
   - изменения в процессах не планируются.

   Для реализации распила подойдет паттерн **Code first: Tactical Forking**, с последующим выпиливанием из 
каждой из систем лишнего кода и данных.

2. Вынесение матчера в отдельный сервис.

   Это Core-поддомен, он критически важен, но у него меньше связей, чем у энтити-сервиса, и техническая сложность 
   в контексте всей системы видится меньшей. Поэтому вторым шагом возьмем его. Для матчинга требуется поменять 
   архитектурный стиль, поэтому для реализации шага подойдет паттерн **Code first: Strangler Fig Application**.

3. Склеиваем энтити-сервис воркеров с сервисом скоринга. В данном случае кажется, что начать следует с данных
(**Data first: Change Data Capture**).

   - Перенести данные из энтити-сервиса в существующую БД сервиса скоринга,
   - На стороне скоринга обеспечить параллельную запись в собственную БД и передачу в энтити-сервис,
   - Переделать коммуникации с консьюмерами данных о воркерах на event driven от скоринга,
   - Закопать энтити-сервис.

### Кейс: есть экспертиза, недостаточно ресурсов

1. Вынесение матчера в отдельный сервис — потому что это Core-домен, который обеспечивает конкурентное преимущество,
высокая ценность для бизнеса. И наибольший Impact за доступное время.
2. Склеиваем энтити-сервис воркеров с сервисом скоринга — потому что, скорее всего, больное и сдерживает 
развитие сервиса Скоринга из-за риска всё сломать (а Скорингу требуется короткий релизный цикл — неделя).
3. Распил сервиса расчётов.

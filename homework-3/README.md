# ДЗ#3

Содержание
- [Стейкхолдеры](#стейкхолдеры)
  - [Power-Interest Matrix](#power-interest-matrix)
  - [Консёрны стейкхолдеров по группам](#консёрны-стейкхолдеров-по-группам)
- [Структура системы и характеристики частей](#структура-системы-и-характеристики-частей)
- [Выбор архитектуры](#выбор-архитектуры)
  - [Архитектурный стиль и БД сервисов](#архитектурный-стиль-и-бд-сервисов)
  - [Коммуникации](#коммуникации)
- [Фитнес-функции](#фитнес-функции)
- [ADR: скоринг в виде отдельного сервиса](#adr-скоринг-в-виде-отдельного-сервиса)

## Стейкхолдеры
1. **Владельцы бизнеса и топ-менеджмент**
   
    Потенциально это могли бы быть разные группы, но в данном случае у нас нет информации о специфических консёрнах 
    каждой из групп, поэтому считаем, что топ-менеджмент полностью транслирует интересы оунеров.

2. **Сотрудники финансового отдела**
3. **Юристы**
4. **Менеджеры**

   Вообще у нас можно выделить четыре роли менеджеров:
    - HR-менеджеры,
    - Менеджеры склада,
    - Менеджеры контроля качества,
    - Аккаунт-менеджеры.

   Потенциально у них могут быть разные консёрны, но нам об этом ничего не известно.

5. **Админы**
6. **Разработчики**
7. **Разработчики алгоритмов матчинга** — выношу в отдельную группу, полагаю, тут речь про разработку и реализацию
модели матчинга. У этой группы есть специфический консёрн, который влияет на реализацию ([US-300])
8. **Пользователи системы**
    - Клиенты,
    - Воркеры.
   
   Их консерёрны в ТЗ явно не указаны, но компания планирует собирать обратную связь через контроль качества,
   значит, в будущем они могут иметь влияние на систему.

### Power-Interest Matrix

![Power-Interest Matrix](https://github.com/foxy-eyed/mcf-project/blob/main/homework-3/img/power_interest_matrix.jpg)

### Консёрны стейкхолдеров по группам

| Стейкхолдеры                     | Консёрны                                                                                                                                                                                                   |
|----------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Владельцы и топ-менеджмент       | 1. тестировать больше гипотез<br>2. продажа системы как продукта в будущем<br>3. релизный цикл для всей системы — месяц<br>4. релизный цикл для скоринга работников — неделя максимум                      |
| Сотрудники финансового отдела    | 1. независимые друг от друга и изменяемые частоты списаний и выплат воркерам<br>2. хотят надежное хранение финансовой информации<br>3. хотят постоянно добавлять новые способы списания денег для клиентов |
| Юристы                           | соответствие всей системы правовым нормам                                                                                                                                                                  |
| Менеджеры                        | 1. хотят изолировать и скрыть систему ставок<br>2. система должна справляться с потоком заказов 10 шт в минуту (и масштабироваться)                                                                        |
| Админы                           | простота мониторинга системы                                                                                                                                                                               |
| Разработчики                     | 1. система должна работать без сбоев<br>2. если сбой случается, то должно быть понятно, что и где чинить                                                                                                   |
| Разработчики алгоритмов матчинга | иметь возможность самостоятельно добавлять или редактировать шаги алгоритма в систему                                                                                                                      |
| Пользователи системы             | ожидаемое поведение системы: без сбоев и тупняков                                                                                                                                                          |

## Структура системы и характеристики частей

Структура системы, полученная в предыдущем уроке:

![System structure](https://github.com/foxy-eyed/mcf-project/blob/main/homework-3/img/system_structure.jpg)

В таблице ниже выписала характеристики, выделенные из требований, ограничений и консёрнов стейкхолдеров,
сгруппированные по контекстам:

| Часть системы                       | Характеристики                                                                                                                                                           | Ограничения, консёрны, требования из ТЗ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|-------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Система в целом                     | - Modifiability, <br>- Maintainability,<br>- Scalability, <br>- Agility, <br>- Evolvability,<br>- Testability, <br>- Deployability, <br>- Consistency, <br>- Reliability | - Компания планирует расширяться в будущем;<br>- Бизнесу необходим низкий ТТМ (Time To Market), чтобы конкурировать на рынке;<br>- Соблюдение CatFinCompliance, который говорит об особом способе хранения данных и особой наблюдаемости за системой;<br>- Релизный цикл для всей системы — месяц;<br>- Система должна работать без сбоев, а если сбой случается, то должно быть понятно, что и где чинить;<br>- Простота мониторинга системы для своевременного замечания сбоев;<br>- Соответствие всей системы правовым нормам. |
| Матчинг                             | - Modifiability, maintainability<br>- Низкий каплинг, agility, evolvability<br>- Deployability, Testability<br>- Scalability, elasticity                                 | - Высокая сложность модели;<br>- Состоит из набора шагов в нужной нам последовательности, которая иногда может изменяться, при этом необходимо иметь возможность добавлять или редактировать шаги;<br>- Изолированность — разработчики не хотят делиться алгоритмами;<br>- Нагрузка будет расти с ростом кол-ва заказов.                                                                                                                                                                                                          |
| Скоринг кандидатов                  | - Modifiability, maintainability<br>- Низкий каплинг, agility, evolvability<br>- Deployability, Testability<br>- Scalability, elasticity<br>- Consistency, securability  | - Высокая сложность модели;<br>- Бизнес в будущем хочет продавать его другим компаниям и тестировать больше гипотез;<br>- Релизный цикл — неделя максимум;<br>- Мы ожидаем 1к заявок в день от рандомных котов, также, судя по отзывам, наши конкуренты могут попытаться нас заддосить в этом месте;<br>- Менеджеры должны иметь возможность конфигурировать набор тестов под каждого отдельного кота или вакансию котов;<br>- Требуется надежно хранить персональные данные котов-воркеров.                                      |
| Система ставок                      | - Scalability, elasticity                                                                                                                                                | - Менеджеры хотят, чтобы о системе ставок знали минимум причастных;<br>- Ставки могут делать только менеджеры, которых будет не больше 15 голов;<br>- Количество ставок коррелирует с кол-вом заказов, поэтому должно масштабироваться соответственно.                                                                                                                                                                                                                                                                            |
| Заказ и трекинг выполнения задач    | - Scalability, elasticity<br>- Usability                                                                                                                                 | - Выяснилось, что котам из Happy Cat Box наш проект понравился, поэтому приходит не 10 заказов в день, а 10 заказов в минуту;<br>- Ожидаемое поведение системы: без сбоев и тупняков (консёрн клиентов).                                                                                                                                                                                                                                                                                                                          |
| Выплата вознаграждений исполнителям | - Consistency, securability<br>- Reliability                                                                                                                             | - Требуется надежное хранение и неизменяемость фин данных (консёрн финансового отдела).                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Списание средств с клиентов         | - Consistency, securability<br>- Agility, evolvability<br>- Deployability, Testability<br>- Reliability                                                                  | - Требуется надежное хранение и неизменяемость фин данных (консёрн финансового отдела);<br>- Необходимо постоянно добавлять новые способы списания денег для клиентов.                                                                                                                                                                                                                                                                                                                                                            |

## Выбор архитектуры

Опираясь на общие характеристики системы — *Deployability*, *Testability*, *Agility* — 
делаю выбор в пользу **микросервисной архитектуры**.

Ниже описала, какие контексты стоит выделить в отдельные сервисы и почему.

1. **Скоринг кандидатов**
   - для него явно указан специфический релизный цикл — 1 неделя против 1 месяца для всей системы;
   - в будущем скоринг планируется продавать как продукт, его стоит сразу изолировать от прочей бизнес-логики;
   - потенциально самая нагруженная часть системы;

2. **Матчинг**
   - знания об алгоритме матчинга должны быть инкапсулированы внутри одной команды;

3. **Система ставок**
   - вся система в целом должна соотв. правовым нормам (консёрн юристов), а эта часть находится в серой зоне;
   - требуется ограничить доступ к информации о ставках (и в целом информированность о тотализаторе) для узкой группы пользователей;

4. **Списание средств с клиентов**
   - тут есть требование постоянно добавлять новые способы списания денег, лучше иметь возможность деплоить отдельно;
   - CatFinCompliance;

5. **Выплата вознаграждений воркерам**
   - CatFinCompliance;

6. **Комплектация заказов**
   - вынесла по принципу отдельного домена со своей спецификой и отдельных людей, которые занимаются комплектацией заказов;

7. **Заказ печенья**
   - относится к generic-поддомену, можно использовать стороннее решение.

Оставшиеся контексты можно объединить в один сервис, поскольку:
 - нет специфических противоречащих требований,
 - есть связанность на уровне данных.

Итоговая структура сервисов:

![Services](https://github.com/foxy-eyed/mcf-project/blob/main/homework-3/img/services.jpg)

### Архитектурный стиль и БД сервисов

| Сервис                             | Архитектурный стиль | БД             |
|------------------------------------|---------------------|----------------|
| Скоринг                            | Microkernel         | Реляционная БД |
| Матчинг                            | Pipeline            | Реляционная БД |
| Списание средств с клиентов        | Layered monolith    | Реляционная БД |
| Выплата вознаграждений воркерам    | Layered monolith    | Реляционная БД |
| Комплектация заказов               | Layered monolith    | Реляционная БД |
| Оказание услуг и контроль качества | Modular monolith    | Реляционная БД |

Каждый из сервисов имеет собственную реляционную БД.

### Коммуникации

Сервис **Скоринга** после апрува кандидата должен отправлять стриминговое событие сразу в два сервиса:
в **Матчинг** и в **Оказание услуг**. Можно делать два синхронных запроса, но поскольку нам не нужно ничего получать
в ответ, мы можем выбрать асинхронную event-driven коммуникацию: генерировать событие для произвольного кол-ва консьюмеров.

**Оказание услуг** должен вызывать сервис **Матчинга** сразу после создания заказа. Обращение к матчеру имеет смысл сделать 
асинхронным: из-за сложности алгоритма и анализа исторических данных матчинг может занимать значительное время,
не стоит держать коннекшн. После окончания матчинга сервис присылает обратно стриминговое событие с выбранным воркером.

Для консистентности event-driven коммуникацию распространила на все взаимодействия сервиса **Оказание услуг**
с другими сервисами.

Ниже коммуникации между сервисами показаны на схеме: 
 - красные стрелки — бизнес-события,
 - синие — стриминговые события,
 - пунктир означает асинхронную коммуникацию,
 - сплошная линия — синхронная коммуникация с внешними сервисами.

![Communications](https://github.com/foxy-eyed/mcf-project/blob/main/homework-3/img/communications.jpg)

## Фитнес-функции

| Сервис                      | Фитнес-функции                                                                                                                                        |
|-----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| Вся система                 | - Проверка частоты релизов (не реже раза в месяц);<br>- Покрытие тестами не ниже X (CI pipeline);<br>- Скорость доставки фич в прод (метрики в Jira); |
| Скоринг                     | - Проверка частоты релизов (не реже раза в неделю);<br>- Нагрузочные тесты;                                                                           |
| Матчинг                     | - Теоретически можно придумать, как добавить обратную связь для определения качества алгоритма матчинга через опрос клиентов и воркеров;              |
| Списание средств с клиентов | - Скорость прикручивания нового платежного шлюза;                                                                                                     |
| Оказание услуг              | - FF для контроля кросс-контекстных вызовов (допустим, у нас проект на Ruby :))                                                                       |

## ADR: скоринг в виде отдельного сервиса
### Status
Proposed

### Context
В процессе сбора требований, ограничений и консёрнов стейкхолдеров были выявлены следующие моменты:
  - Бизнес в будущем хочет продавать его другим компаниям;
  - Есть пожелание тестировать как можно больше гипотез;
  - Высокая сложность модели и в будущем она будет усложняться;
  - Релизный цикл — неделя максимум;
  - Ожидаемая нагрузка — 1к заявок в день от рандомных котов;
  - Есть опасения, что конкуренты могут попытаться нас заддосить в этом месте;
  - Менеджеры должны иметь возможность конфигурировать набор тестов под каждого отдельного кота или вакансию котов;
  - Необходимость собирать персональные данные котов-воркеров требует соблюдения GDPR compliance.

При этом требование к частоте релиза всей системы целиком — раз в месяц.

Кроме того, озвучены следующие ограничения, актуальные для всей системы:
   - инфраструктуру считаем бесплатной;
   - соблюдение CatFinCompliance, который говорит об особом способе хранения данных и особой наблюдаемости за системой.
 
### Decision
Выделяем скоринг в отдельный сервис. Основные аргументы:
  - специфический релизный цикл (чаще чем остальные части системы);
  - в будущем скоринг планируется продавать как продукт;
  - потенциально самая нагруженная часть системы.

Для реализации сервиса преложен Microkernel архитектурный стиль.

Сервис имеет собственную реляционную БД в связи с CatFinCompliance.

### Consequences
Плюсы:
 + возможность релизить сервис отдельно от остальной системы с требуемой частотой;
 + отказ сервиса не должен повлиять на работоспособность системы;
 + возможность отдельно скейлить;
 + можно будет продавать сервис независимо от других частей системы как продукт внешним компаниям.

Минусы:
 - увеличивается сложность коммуникаций между частями системы — потребуется передавать информацию о нанятых воркерах.

### Compliance
- Проверка частоты релизов (не реже раза в неделю);
- Покрытие тестами не ниже X (CI pipeline);
- Скорость доставки фич в прод (метрики в Jira);
- Нагрузочные тесты.
